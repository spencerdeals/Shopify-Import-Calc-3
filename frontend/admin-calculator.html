<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Calculator - SDL Internal Pricing Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a2a6c;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            resize: vertical;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[type="number"],
        .form-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            box-shadow: 0 4px 15px rgba(86, 171, 47, 0.4);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #c33;
        }

        .product-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .product-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .product-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .product-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        .product-info {
            flex: 1;
        }

        .product-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a2a6c;
            margin-bottom: 8px;
        }

        .product-meta {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .boxes-section {
            background: #fff3e0;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #ff9800;
        }

        .boxes-section h4 {
            color: #e65100;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .box-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #ffcc80;
            position: relative;
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .box-label {
            font-weight: 600;
            color: #e65100;
        }

        .btn-remove-box {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .box-dimensions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .dimension-field {
            display: flex;
            flex-direction: column;
        }

        .dimension-field label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .dimension-field input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .btn-add-box {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-add-box:hover {
            background: #f57c00;
        }

        .pricing-section {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .price-row.highlight {
            background: #c8e6c9;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            margin: 8px 0;
        }

        .price-row.total {
            font-size: 20px;
            font-weight: 700;
            color: #1b5e20;
            border-top: 3px solid #4caf50;
            padding-top: 15px;
            margin-top: 15px;
        }

        .margin-editor {
            background: #fff9e6;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #ffc107;
        }

        .margin-editor label {
            font-size: 13px;
            font-weight: 600;
            color: #f57c00;
            display: block;
            margin-bottom: 8px;
        }

        .margin-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .margin-input-group input {
            width: 120px;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .margin-suggestion {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .review-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .review-table th {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .review-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .review-table tr:hover {
            background: #f5f5f5;
        }

        .review-table input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .collection-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .collection-badge.uncertain {
            background: #fff3e0;
            color: #f57c00;
            border: 2px dashed #ff9800;
        }

        .image-carousel {
            position: relative;
            width: 120px;
            height: 120px;
            background: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
        }

        .carousel-images {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .carousel-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .carousel-image.active {
            opacity: 1;
            pointer-events: auto;
        }

        .carousel-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
        }

        .carousel-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .carousel-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .carousel-counter {
            color: white;
            font-size: 11px;
            font-weight: 600;
            flex: 1;
            text-align: center;
        }

        .carousel-reorder {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .reorder-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .reorder-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .reorder-btn.delete {
            background: rgba(244, 67, 54, 0.95);
            color: white;
        }

        .reorder-btn.delete:hover {
            background: #f44336;
        }

        .no-image {
            width: 120px;
            height: 120px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .box-dimensions {
                grid-template-columns: repeat(2, 1fr);
            }

            .review-table {
                font-size: 11px;
            }

            .review-table th,
            .review-table td {
                padding: 8px;
            }

            .image-carousel {
                width: 80px;
                height: 80px;
            }

            .no-image {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin Calculator</h1>
            <p>Internal Pricing Tool for SDL</p>
        </div>

        <div class="content">
            <!-- Screen 1: Paste Links -->
            <div id="screen1" class="screen active">
                <h2 class="section-title">Paste Product Links</h2>

                <div class="form-group" style="max-width: 400px; margin-bottom: 30px;">
                    <label for="freightRate">Freight Fee per Cubic Foot ($)</label>
                    <input type="number" id="freightRate" step="0.01" min="0" value="18.00"
                           onchange="updateFreightRate(parseFloat(this.value))"
                           style="width: 100%; padding: 12px; font-size: 16px; font-weight: 600;
                                  border: 2px solid #667eea; border-radius: 8px;">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        All calculations use: $<span id="currentRate">18.00</span>/ft³ (Minimum freight: $30)
                    </small>
                </div>

                <div class="form-group">
                    <label for="productUrls">Product URLs (one per line)</label>
                    <textarea id="productUrls" rows="12" placeholder="https://www.amazon.com/product-link
https://www.wayfair.com/product-link
https://www.target.com/product-link

Paste your product URLs here..."></textarea>
                </div>
                <button class="btn" onclick="fetchProducts()">Fetch Products</button>
                <button class="btn btn-secondary" onclick="clearAll()">Clear</button>
                <div id="fetchError"></div>
            </div>

            <!-- Screen 2: Dimensions & Costs -->
            <div id="screen2" class="screen">
                <h2 class="section-title">Dimensions & Costs</h2>
                <div id="productsContainer"></div>
                <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                    <button class="btn btn-secondary" onclick="goToScreen(1)">Back</button>
                    <button class="btn btn-success" onclick="goToScreen(3)">Review & Export</button>
                </div>
            </div>

            <!-- Screen 3: Review & Export -->
            <div id="screen3" class="screen">
                <h2 class="section-title">Review & Shopify Export</h2>
                <div id="reviewContainer"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="goToScreen(2)">Back</button>
                    <button class="btn btn-success" onclick="exportShopifyCSV()">Download Shopify Products CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let freightRatePerCuft = 18.00; // Initial value: $18.00 per cubic foot (user can change)

        // Update freight rate from user input
        function updateFreightRate(value) {
            freightRatePerCuft = value || 18.00;
            document.getElementById('currentRate').textContent = freightRatePerCuft.toFixed(2);

            // Update all product freight rate suggestions that are not overridden
            products.forEach((product, idx) => {
                if (product.freightRateOverride === null || product.freightRateOverride === undefined) {
                    const freightRateSuggestion = document.getElementById(`freight-rate-suggestion-${idx}`);
                    if (freightRateSuggestion) {
                        freightRateSuggestion.textContent = `Using global: $${freightRatePerCuft.toFixed(2)}/ft³`;
                    }
                }
            });

            // Recalculate all product pricing if products exist
            products.forEach((_, idx) => calculatePricing(idx));
        }

        // Dynamic margin rules
        function getDefaultMargin(landedCost) {
            if (landedCost < 200) return 70;
            if (landedCost < 500) return 60;
            if (landedCost < 1000) return 55;
            if (landedCost < 2500) return 50;
            return 48;
        }

        function getMarginTierLabel(landedCost) {
            if (landedCost < 200) return 'Under $200: 70% margin';
            if (landedCost < 500) return '$200-$499: 60% margin';
            if (landedCost < 1000) return '$500-$999: 55% margin';
            if (landedCost < 2500) return '$1,000-$2,499: 50% margin';
            return 'Over $2,500: 48% margin';
        }

        // Round up to next $5
        function roundToNext5(price) {
            return Math.ceil(price / 5) * 5;
        }

        // Auto-assign collection
        function autoAssignCollection(product) {
            const text = `${product.name || ''} ${product.category || ''} ${product.retailer || ''}`.toLowerCase();

            if (text.match(/sofa|sectional|couch|loveseat/)) return { collection: 'Sofas & Sectionals', uncertain: false };
            if (text.match(/chair|armchair|recliner|seating/)) return { collection: 'Chairs & Seating', uncertain: false };
            if (text.match(/table|coffee table|end table|dining table|desk/)) return { collection: 'Tables', uncertain: false };
            if (text.match(/bed|mattress|headboard|nightstand|dresser/)) return { collection: 'Bedroom', uncertain: false };
            if (text.match(/lamp|lighting|chandelier/)) return { collection: 'Lighting', uncertain: false };
            if (text.match(/rug|carpet/)) return { collection: 'Rugs', uncertain: false };
            if (text.match(/decor|mirror|art|vase/)) return { collection: 'Home Decor', uncertain: false };
            if (text.match(/outdoor|patio|garden/)) return { collection: 'Outdoor', uncertain: false };

            return { collection: 'Uncategorized', uncertain: true };
        }

        // Screen navigation
        function goToScreen(screenNumber) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen${screenNumber}`).classList.add('active');

            if (screenNumber === 3) {
                renderReviewScreen();
            }
        }

        // Fetch products
        async function fetchProducts() {
            const urls = document.getElementById('productUrls').value.trim();
            if (!urls) {
                alert('Please enter at least one product URL');
                return;
            }

            const urlList = urls.split('\n').filter(url => url.trim());
            const errorDiv = document.getElementById('fetchError');
            errorDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Scraping products... This may take a moment...</p></div>';

            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: urlList })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                products = (data.products || []).map(p => ({
                    ...p,
                    boxes: [{
                        length: p.dimensions?.length || 24,
                        width: p.dimensions?.width || 18,
                        height: p.dimensions?.height || 12,
                        weight: p.weight || 10
                    }],
                    vendor: p.brand || p.retailer || 'Unknown',
                    basePrice: p.price || 0,
                    customMargin: null,
                    cuftOverride: null,
                    freightRateOverride: null,
                    dutyRateOverride: null,
                    // Store additional ZEITS data for CSV export
                    breadcrumbs: p.breadcrumbs || [],
                    descriptionHtml: p.description || '',
                    sku: p.sku || '',
                    variants: p.variantOptions || [],
                    allVariants: p.allVariants || [],
                    rating: p.rating || null,
                    reviews: p.reviews || null,
                    images: p.images || []
                }));

                errorDiv.innerHTML = '';
                goToScreen(2);
                renderProductsScreen();

            } catch (error) {
                console.error('Error fetching products:', error);
                errorDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Render products screen
        function renderProductsScreen() {
            const container = document.getElementById('productsContainer');
            if (!products.length) {
                container.innerHTML = '<div class="error">No products found</div>';
                return;
            }

            container.innerHTML = products.map((product, idx) => `
                <div class="product-card">
                    <div class="product-header">
                        <img src="${product.image || 'https://placehold.co/100x100?text=No+Image'}"
                             alt="${product.name}" class="product-thumbnail">
                        <div class="product-info">
                            <div class="product-title">${product.name || 'Unnamed Product'}</div>
                            <div class="product-meta">
                                <strong>Vendor:</strong>
                                <input type="text" value="${product.vendor}"
                                       onchange="updateProductField(${idx}, 'vendor', this.value)"
                                       style="width: 200px; display: inline-block;">
                            </div>
                            <div class="product-meta"><strong>Source:</strong> ${product.url}</div>
                            <div class="product-meta">
                                <strong>Base Price:</strong> $
                                <input type="number" value="${product.basePrice}" step="0.01" min="0"
                                       onchange="updateProductField(${idx}, 'basePrice', parseFloat(this.value))"
                                       style="width: 100px; display: inline-block;">
                            </div>
                        </div>
                    </div>

                    <div class="boxes-section">
                        <h4>Shipping Boxes</h4>
                        <div id="boxes-${idx}"></div>
                        <button class="btn-add-box" onclick="addBox(${idx})">+ Add Box</button>
                    </div>

                    <div class="margin-editor" style="background: #e3f2fd; border-left: 5px solid #2196f3;">
                        <label style="color: #1565c0;">Override Cubic Footage (ft³)</label>
                        <div class="margin-input-group">
                            <input type="number" id="cuft-override-${idx}" step="0.001" min="0"
                                   placeholder="Auto-calculated"
                                   onchange="updateCuftOverride(${idx}, parseFloat(this.value) || null)">
                            <span class="margin-suggestion" id="cuft-suggestion-${idx}"></span>
                        </div>
                    </div>

                    <div class="margin-editor" style="background: #fff3e0; border-left: 5px solid #ff9800;">
                        <label style="color: #e65100;">Freight Rate ($/ft³)</label>
                        <div class="margin-input-group">
                            <input type="number" id="freight-rate-${idx}" step="0.01" min="0"
                                   placeholder="18.00"
                                   onchange="updateFreightRateOverride(${idx}, parseFloat(this.value) || null)">
                            <span class="margin-suggestion" id="freight-rate-suggestion-${idx}">Using global: $18.00/ft³</span>
                        </div>
                    </div>

                    <div class="margin-editor" style="background: #fce4ec; border-left: 5px solid #e91e63;">
                        <label style="color: #c2185b;">Duty & Wharfage Rate (%)</label>
                        <div class="margin-input-group">
                            <input type="number" id="duty-rate-${idx}" step="0.01" min="0" max="100"
                                   placeholder="26.25"
                                   onchange="updateDutyRate(${idx}, parseFloat(this.value) || null)">
                            <span class="margin-suggestion" id="duty-rate-suggestion-${idx}">Default: 26.25%</span>
                        </div>
                    </div>

                    <div class="margin-editor">
                        <label>Profit Margin (%)</label>
                        <div class="margin-input-group">
                            <input type="number" id="margin-${idx}" step="0.5" min="0" max="100"
                                   onchange="updateMargin(${idx}, parseFloat(this.value))">
                            <span class="margin-suggestion" id="margin-suggestion-${idx}"></span>
                        </div>
                    </div>

                    <div class="pricing-section" id="pricing-${idx}"></div>
                </div>
            `).join('');

            // Render boxes and calculate pricing for each product
            products.forEach((_, idx) => {
                renderBoxes(idx);
                calculatePricing(idx);
            });
        }

        // Render boxes
        function renderBoxes(productIdx) {
            const product = products[productIdx];
            const container = document.getElementById(`boxes-${productIdx}`);

            container.innerHTML = product.boxes.map((box, boxIdx) => `
                <div class="box-item">
                    <div class="box-header">
                        <span class="box-label">Box ${boxIdx + 1}</span>
                        ${product.boxes.length > 1 ? `
                            <button class="btn-remove-box" onclick="removeBox(${productIdx}, ${boxIdx})">Remove</button>
                        ` : ''}
                    </div>
                    <div class="box-dimensions">
                        <div class="dimension-field">
                            <label>Length (in)</label>
                            <input type="number" value="${box.length}" step="0.1" min="0"
                                   onchange="updateBoxDimension(${productIdx}, ${boxIdx}, 'length', parseFloat(this.value))">
                        </div>
                        <div class="dimension-field">
                            <label>Width (in)</label>
                            <input type="number" value="${box.width}" step="0.1" min="0"
                                   onchange="updateBoxDimension(${productIdx}, ${boxIdx}, 'width', parseFloat(this.value))">
                        </div>
                        <div class="dimension-field">
                            <label>Height (in)</label>
                            <input type="number" value="${box.height}" step="0.1" min="0"
                                   onchange="updateBoxDimension(${productIdx}, ${boxIdx}, 'height', parseFloat(this.value))">
                        </div>
                        <div class="dimension-field">
                            <label>Weight (lbs)</label>
                            <input type="number" value="${box.weight}" step="0.1" min="0"
                                   onchange="updateBoxDimension(${productIdx}, ${boxIdx}, 'weight', parseFloat(this.value))">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Add/remove boxes
        function addBox(productIdx) {
            products[productIdx].boxes.push({ length: 24, width: 18, height: 12, weight: 10 });
            renderBoxes(productIdx);
            calculatePricing(productIdx);
        }

        function removeBox(productIdx, boxIdx) {
            if (products[productIdx].boxes.length > 1) {
                products[productIdx].boxes.splice(boxIdx, 1);
                renderBoxes(productIdx);
                calculatePricing(productIdx);
            }
        }

        // Update box dimension
        function updateBoxDimension(productIdx, boxIdx, field, value) {
            products[productIdx].boxes[boxIdx][field] = value || 0;
            // Clear override when box dimensions change to use auto-calculated value
            products[productIdx].cuftOverride = null;
            calculatePricing(productIdx);
        }

        // Update product field
        function updateProductField(productIdx, field, value) {
            products[productIdx][field] = value;
            if (field === 'basePrice') {
                calculatePricing(productIdx);
            }
        }

        // Update margin
        function updateMargin(productIdx, value) {
            products[productIdx].customMargin = value > 0 ? value : null;
            calculatePricing(productIdx);
        }

        // Update cubic feet override
        function updateCuftOverride(productIdx, value) {
            products[productIdx].cuftOverride = value;
            calculatePricing(productIdx);
        }

        // Update freight rate override
        function updateFreightRateOverride(productIdx, value) {
            products[productIdx].freightRateOverride = value;
            const freightRateSuggestion = document.getElementById(`freight-rate-suggestion-${productIdx}`);
            if (freightRateSuggestion) {
                if (value) {
                    freightRateSuggestion.textContent = `Custom: $${value.toFixed(2)}/ft³`;
                } else {
                    freightRateSuggestion.textContent = `Using global: $${freightRatePerCuft.toFixed(2)}/ft³`;
                }
            }
            calculatePricing(productIdx);
        }

        // Update duty rate
        function updateDutyRate(productIdx, value) {
            products[productIdx].dutyRateOverride = value;
            const dutyRateSuggestion = document.getElementById(`duty-rate-suggestion-${productIdx}`);
            if (dutyRateSuggestion) {
                if (value) {
                    dutyRateSuggestion.textContent = `Custom: ${value.toFixed(2)}%`;
                } else {
                    dutyRateSuggestion.textContent = `Default: 26.25%`;
                }
            }
            calculatePricing(productIdx);
        }

        // Update review field
        function updateReviewField(productIdx, field, value) {
            products[productIdx][field] = value;
        }

        // Update MSRP override
        function updateMsrpOverride(productIdx, value) {
            if (products[productIdx].calculated) {
                products[productIdx].calculated.msrpRounded = value;
            }
        }

        // Calculate pricing
        function calculatePricing(productIdx) {
            const product = products[productIdx];
            const basePrice = product.basePrice || 0;

            // Calculate total cubic feet from all boxes
            let totalCubicFeet = 0;
            product.boxes.forEach(box => {
                const cubicInches = box.length * box.width * box.height;
                totalCubicFeet += cubicInches / 1728;
            });

            // Use override if available, otherwise calculate
            const effectiveCubicFeet = product.cuftOverride !== null && product.cuftOverride !== undefined
                ? product.cuftOverride
                : totalCubicFeet;

            // Freight rate: Use product override if available, otherwise use global rate
            const effectiveFreightRate = product.freightRateOverride !== null && product.freightRateOverride !== undefined
                ? product.freightRateOverride
                : freightRatePerCuft;

            // Freight: Use effective rate per cubic foot, $30 minimum
            const freightCost = Math.max(30, effectiveCubicFeet * effectiveFreightRate);

            // Duty rate: Use product override if available, otherwise use default 26.25%
            const effectiveDutyRate = product.dutyRateOverride !== null && product.dutyRateOverride !== undefined
                ? product.dutyRateOverride / 100
                : 0.2625;

            // Duty & Wharfage: Use combined rate
            const dutyAndWharfageCombined = basePrice * effectiveDutyRate;

            // For display purposes, split approximately into duty and wharfage
            const wharfage = dutyAndWharfageCombined * 0.057; // ~1.5% of 26.25%
            const dutyAmount = dutyAndWharfageCombined - wharfage;

            // Total landed cost
            const landedCost = basePrice + freightCost + dutyAndWharfageCombined;

            // Determine margin
            const defaultMargin = getDefaultMargin(landedCost);
            const marginPercent = product.customMargin !== null ? product.customMargin : defaultMargin;
            const marginAmount = landedCost * (marginPercent / 100);

            // MSRP before rounding
            const msrpBeforeRounding = landedCost + marginAmount;

            // Round UP to next $5
            const msrpRounded = roundToNext5(msrpBeforeRounding);

            // Store calculated values
            product.calculated = {
                totalCubicFeet,
                effectiveCubicFeet,
                effectiveFreightRate,
                effectiveDutyRate: effectiveDutyRate * 100,
                freightCost,
                dutyAmount,
                wharfage,
                landedCost,
                marginPercent,
                marginAmount,
                msrpBeforeRounding,
                msrpRounded
            };

            // Update cubic feet override input
            const cuftOverrideInput = document.getElementById(`cuft-override-${productIdx}`);
            const cuftSuggestion = document.getElementById(`cuft-suggestion-${productIdx}`);

            // Always populate the input with the effective cubic footage
            if (cuftOverrideInput) {
                cuftOverrideInput.value = effectiveCubicFeet.toFixed(3);
            }

            if (cuftSuggestion) {
                if (product.cuftOverride !== null && product.cuftOverride !== undefined) {
                    cuftSuggestion.textContent = `Auto-calculated from boxes: ${totalCubicFeet.toFixed(3)} ft³`;
                } else {
                    cuftSuggestion.textContent = `Calculated from ${product.boxes.length} box${product.boxes.length > 1 ? 'es' : ''}`;
                }
            }

            // Update freight rate input
            const freightRateInput = document.getElementById(`freight-rate-${productIdx}`);
            const freightRateSuggestion = document.getElementById(`freight-rate-suggestion-${productIdx}`);
            if (freightRateInput) {
                if (product.freightRateOverride !== null && product.freightRateOverride !== undefined) {
                    freightRateInput.value = product.freightRateOverride.toFixed(2);
                }
            }
            if (freightRateSuggestion) {
                if (product.freightRateOverride !== null && product.freightRateOverride !== undefined) {
                    freightRateSuggestion.textContent = `Custom: $${effectiveFreightRate.toFixed(2)}/ft³`;
                } else {
                    freightRateSuggestion.textContent = `Using global: $${freightRatePerCuft.toFixed(2)}/ft³`;
                }
            }

            // Update duty rate input
            const dutyRateInput = document.getElementById(`duty-rate-${productIdx}`);
            const dutyRateSuggestion = document.getElementById(`duty-rate-suggestion-${productIdx}`);
            if (dutyRateInput) {
                if (product.dutyRateOverride !== null && product.dutyRateOverride !== undefined) {
                    dutyRateInput.value = product.dutyRateOverride.toFixed(2);
                }
            }
            if (dutyRateSuggestion) {
                if (product.dutyRateOverride !== null && product.dutyRateOverride !== undefined) {
                    dutyRateSuggestion.textContent = `Custom: ${(effectiveDutyRate * 100).toFixed(2)}%`;
                } else {
                    dutyRateSuggestion.textContent = `Default: 26.25%`;
                }
            }

            // Update margin input
            const marginInput = document.getElementById(`margin-${productIdx}`);
            const marginSuggestion = document.getElementById(`margin-suggestion-${productIdx}`);
            if (marginInput && !marginInput.value) {
                marginInput.value = defaultMargin.toFixed(1);
            }
            if (marginSuggestion) {
                marginSuggestion.textContent = product.customMargin !== null
                    ? `Suggested: ${defaultMargin.toFixed(1)}% (${getMarginTierLabel(landedCost)})`
                    : `Auto: ${getMarginTierLabel(landedCost)}`;
            }

            // Update pricing display
            const pricingDiv = document.getElementById(`pricing-${productIdx}`);
            if (pricingDiv) {
                const cuftDisplayValue = product.cuftOverride !== null && product.cuftOverride !== undefined
                    ? `${effectiveCubicFeet.toFixed(3)} ft³ (overridden)`
                    : `${totalCubicFeet.toFixed(3)} ft³`;

                pricingDiv.innerHTML = `
                    <div class="price-row">
                        <span>Total Cubic Feet (${product.boxes.length} box${product.boxes.length > 1 ? 'es' : ''}):</span>
                        <span>${cuftDisplayValue}</span>
                    </div>
                    <div class="price-row">
                        <span>Product Price:</span>
                        <span>$${basePrice.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>Freight Cost ($${effectiveFreightRate.toFixed(2)}/ft³, $30 min):</span>
                        <span>$${freightCost.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>Duty & Wharfage (${(effectiveDutyRate * 100).toFixed(2)}%):</span>
                        <span>$${dutyAndWharfageCombined.toFixed(2)}</span>
                    </div>
                    <div class="price-row highlight">
                        <span>Total Landed Cost:</span>
                        <span>$${landedCost.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>Profit Margin (${marginPercent.toFixed(1)}%):</span>
                        <span>$${marginAmount.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>MSRP (before rounding):</span>
                        <span>$${msrpBeforeRounding.toFixed(2)}</span>
                    </div>
                    <div class="price-row total">
                        <span>FINAL MSRP (rounded to $5):</span>
                        <span>$${msrpRounded.toFixed(2)}</span>
                    </div>
                `;
            }
        }

        // Render review screen
        function renderReviewScreen() {
            const container = document.getElementById('reviewContainer');

            const tableRows = products.map((product, idx) => {
                const calc = product.calculated || {};
                const collectionInfo = autoAssignCollection(product);

                // Determine Type from breadcrumbs
                const breadcrumbs = product.breadcrumbs || [];
                const productType = breadcrumbs.length > 0
                    ? (typeof breadcrumbs[breadcrumbs.length - 1] === 'object'
                        ? breadcrumbs[breadcrumbs.length - 1].name
                        : breadcrumbs[breadcrumbs.length - 1])
                    : 'Furniture';

                // Build tags from breadcrumbs and reviews
                let tags = breadcrumbs.map(b => typeof b === 'object' ? b.name : b).join(', ');
                if (product.rating && product.reviews) {
                    tags += tags ? `, ` : '';
                    tags += `Rating: ${product.rating} (${product.reviews} reviews)`;
                }

                // Store collection in product if not already set
                if (!product.customCollection) {
                    product.customCollection = finalCollection;
                }

                // Store validated images array if not already done
                if (!product.validatedImages) {
                    const images = product.images || [product.image];
                    product.validatedImages = images.filter(img => img && img.trim());
                }
                const validImages = product.validatedImages;

                // Build image carousel HTML
                const imageCarouselHtml = validImages.length > 0 ? `
                    <div class="image-carousel" id="carousel-${idx}">
                        <div class="carousel-images">
                            ${validImages.map((img, imgIdx) => `
                                <img src="${typeof img === 'object' ? (img.url || img) : img}"
                                     alt="Product image ${imgIdx + 1}"
                                     class="carousel-image ${imgIdx === 0 ? 'active' : ''}"
                                     data-product="${idx}"
                                     data-image="${imgIdx}">
                            `).join('')}
                        </div>
                        <div class="carousel-controls">
                            ${validImages.length > 1 ? `
                                <button class="carousel-btn prev" onclick="carouselNav(${idx}, -1)" title="Previous image">‹</button>
                                <span class="carousel-counter">1/${validImages.length}</span>
                                <button class="carousel-btn next" onclick="carouselNav(${idx}, 1)" title="Next image">›</button>
                            ` : `<span class="carousel-counter">1/1</span>`}
                        </div>
                        ${validImages.length > 1 ? `
                            <div class="carousel-reorder">
                                <button class="reorder-btn" onclick="reorderImage(${idx}, 'up')" title="Move image up (earlier in gallery)">↑</button>
                                <button class="reorder-btn" onclick="reorderImage(${idx}, 'down')" title="Move image down (later in gallery)">↓</button>
                                <button class="reorder-btn delete" onclick="deleteImage(${idx})" title="Remove current image">✕</button>
                            </div>
                        ` : ''}
                    </div>
                ` : '<div class="no-image">No image</div>';

                return `
                    <tr>
                        <td>${imageCarouselHtml}</td>
                        <td>${product.name || 'Unnamed'}</td>
                        <td><input type="text" value="${product.vendor}" onchange="updateReviewField(${idx}, 'vendor', this.value)"></td>
                        <td><input type="text" value="${productType}" onchange="updateReviewField(${idx}, 'type', this.value)"></td>
                        <td><input type="text" value="${tags}" onchange="updateReviewField(${idx}, 'tags', this.value)"></td>
                        <td>$${(calc.landedCost || 0).toFixed(2)}</td>
                        <td>${(calc.marginPercent || 0).toFixed(1)}%</td>
                        <td><input type="number" value="${(calc.msrpRounded || 0).toFixed(2)}" step="5" onchange="updateMsrpOverride(${idx}, parseFloat(this.value))"></td>
                        <td><input type="text" value="${product.sku || ''}" onchange="updateReviewField(${idx}, 'sku', this.value)"></td>
                        <td>
                            <input type="text"
                                   value="${product.customCollection}"
                                   onchange="updateReviewField(${idx}, 'customCollection', this.value)"
                                   placeholder="Collection"
                                   style="width: 150px;">
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="review-table">
                    <thead>
                        <tr>
                            <th>Images</th>
                            <th>Title</th>
                            <th>Vendor</th>
                            <th>Type</th>
                            <th>Tags</th>
                            <th>Landed Cost</th>
                            <th>Margin</th>
                            <th>Price</th>
                            <th>SKU</th>
                            <th>Collection</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        // ========================================
        // SHOPIFY CSV BUILDER (AdminCalc + Zyte)
        // ========================================

        // Normalization Helpers
        function normalizeHandle(name) {
            return (name || 'product')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
        }

        function cleanOptionValue(value) {
            if (!value) return '';
            return value.toString()
                .trim()
                .replace(/\s+selected$/i, '')
                .replace(/^(color|size|style|material):\s*/i, '')
                .trim();
        }

        function extractLeafType(breadcrumbs) {
            if (!breadcrumbs || breadcrumbs.length === 0) return 'Furniture';

            // Get leaf node
            let leaf = breadcrumbs[breadcrumbs.length - 1];
            if (typeof leaf === 'object') leaf = leaf.name || '';

            // Skip if it's a SKU pattern
            if (/^SKU:\s*/i.test(leaf)) {
                return breadcrumbs.length > 1
                    ? extractLeafType(breadcrumbs.slice(0, -1))
                    : 'Furniture';
            }

            return leaf || 'Furniture';
        }

        function buildTags(product, breadcrumbs, variantValues = {}) {
            const tagSet = new Set();

            // Add Wayfair if from Wayfair
            if (product.url && product.url.includes('wayfair')) {
                tagSet.add('Wayfair');
            }

            // Add breadcrumb nodes (exclude SKU: patterns)
            breadcrumbs.forEach(b => {
                const crumb = typeof b === 'object' ? b.name : b;
                if (crumb && !/^SKU:\s*/i.test(crumb)) {
                    tagSet.add(crumb);
                }
            });

            // Add SKU tag
            if (product.sku) {
                tagSet.add(`SKU:${product.sku}`);
            }

            // Add rating/reviews
            if (product.rating) {
                tagSet.add(`Rating:${product.rating}`);
            }
            if (product.reviews || product.reviewCount) {
                tagSet.add(`Reviews:${product.reviews || product.reviewCount}`);
            }

            // Add variant-specific tags
            if (variantValues.color) {
                tagSet.add(`Color:${variantValues.color}`);
            }
            if (variantValues.size) {
                tagSet.add(`Size:${variantValues.size}`);
            }

            // Sort and join
            return Array.from(tagSet).sort().join(', ');
        }

        function buildComboKey(color, size) {
            if (!color && !size) return 'DEFAULT';
            if (color && size) return `Color:${color}|Size:${size}`;
            if (color) return `Color:${color}`;
            return `Size:${size}`;
        }

        // Extract variant axes from Zyte data
        function extractVariantAxes(product) {
            const colors = new Set();
            const sizes = new Set();

            // Method 1: From variantOptions.colors/sizes
            if (product.variants) {
                if (product.variants.colors && Array.isArray(product.variants.colors)) {
                    product.variants.colors.forEach(c => {
                        const val = cleanOptionValue(c.value || c);
                        if (val) colors.add(val);
                    });
                }
                if (product.variants.sizes && Array.isArray(product.variants.sizes)) {
                    product.variants.sizes.forEach(s => {
                        const val = cleanOptionValue(s.value || s);
                        if (val) sizes.add(val);
                    });
                }
            }

            // Method 2: Parse allVariants array
            if (product.allVariants && Array.isArray(product.allVariants)) {
                product.allVariants.forEach(v => {
                    const colorMatch = v.match(/(?:Color|Colour):\s*([^,•|]+)/i);
                    if (colorMatch) {
                        const val = cleanOptionValue(colorMatch[1]);
                        if (val) colors.add(val);
                    }

                    const sizeMatch = v.match(/(?:Size):\s*([^,•|]+)/i);
                    if (sizeMatch) {
                        const val = cleanOptionValue(sizeMatch[1]);
                        if (val) sizes.add(val);
                    }
                });
            }

            return {
                colors: Array.from(colors),
                sizes: Array.from(sizes)
            };
        }

        // Build variant SKU
        function buildVariantSku(baseSku, color, size) {
            if (!baseSku) return '';

            let suffix = '';
            if (color && size) {
                suffix = `-${color.toUpperCase().replace(/[\s'"]+/g, '-')}-${size.toUpperCase().replace(/[\s'"]+/g, '-')}`;
            } else if (color) {
                suffix = `-${color.toUpperCase().replace(/[\s'"]+/g, '-')}`;
            } else if (size) {
                suffix = `-${size.toUpperCase().replace(/[\s'"]+/g, '-')}`;
            }

            return baseSku + suffix;
        }

        // Export Shopify CSV with full validation
        function exportShopifyCSV() {
            if (!products.length) {
                alert('No products to export');
                return;
            }

            console.log('========================================');
            console.log('SHOPIFY CSV BUILDER - Starting Export');
            console.log('========================================');

            const headers = [
                'Handle', 'Title', 'Body (HTML)', 'Vendor', 'Type', 'Tags', 'Published',
                'Option1 Name', 'Option1 Value', 'Option2 Name', 'Option2 Value',
                'Variant SKU', 'Variant Grams', 'Variant Inventory Tracker', 'Variant Inventory Qty',
                'Variant Inventory Policy', 'Variant Fulfillment Service',
                'Variant Price', 'Variant Compare At Price', 'Variant Requires Shipping', 'Variant Taxable',
                'Variant Barcode',
                'Image Src', 'Image Position', 'Gift Card', 'Status',
                'Cost per item', 'Collection'
            ];

            const rows = [headers];
            const validationErrors = [];

            products.forEach((product, productIdx) => {
                const calc = product.calculated || {};

                // Use custom collection if set, otherwise auto-assign
                const finalCollection = product.customCollection || autoAssignCollection(product).collection;

                // AdminCalc data (source of truth for pricing)
                const variantPrice = calc.msrpRounded || 0;
                const costPerItem = calc.landedCost || 0;

                // Zyte data
                const handle = normalizeHandle(product.name);
                const breadcrumbs = product.breadcrumbs || [];
                const productType = extractLeafType(breadcrumbs);
                const vendor = product.vendor || product.brand || 'SDL';
                const baseSku = product.sku || '';

                // Build body HTML
                let bodyHtml = product.descriptionHtml || product.description || '';
                if (product.url) {
                    const sourceLink = `<p><small>Source: <a href="${product.url}" target="_blank" rel="nofollow">Wayfair product page</a></small></p>`;
                    bodyHtml += bodyHtml ? '<br><br>' + sourceLink : sourceLink;
                }

                // Extract variant axes
                const axes = extractVariantAxes(product);

                console.log(`\n[Product ${productIdx + 1}] ${product.name}`);
                console.log(`ZYTE_KEYS: name, sku, vendor, breadcrumbs(${breadcrumbs.length}), variants, rating, reviews`);
                console.log(`AXES: Color(${axes.colors.length}), Size(${axes.sizes.length})`);
                console.log(`TYPE_FROM_BREADCRUMBS: "${productType}" from [${breadcrumbs.map(b => typeof b === 'object' ? b.name : b).join(' / ')}]`);
                console.log(`PRICE_LOCK: Variant Price = $${variantPrice.toFixed(2)}, Cost per item = $${costPerItem.toFixed(2)}`);

                // Use validated/reordered images for export
                const exportImages = product.validatedImages || product.images || [product.image];
                const validExportImages = exportImages.filter(img => img && img.trim());

                // Generate variant rows
                let variantRows = [];
                let imagePosition = 1;

                if (axes.colors.length > 0 && axes.sizes.length > 0) {
                    // Two options: Color × Size Cartesian product
                    axes.colors.forEach(color => {
                        axes.sizes.forEach(size => {
                            const tags = buildTags(product, breadcrumbs, { color, size });
                            const comboKey = buildComboKey(color, size);
                            const variantSku = buildVariantSku(baseSku, color, size);

                            variantRows.push([
                                handle,
                                product.name || 'Unnamed Product',
                                bodyHtml,
                                vendor,
                                productType,
                                tags,
                                'TRUE',
                                'Color',
                                color,
                                'Size',
                                size,
                                variantSku,
                                product.weight ? Math.round(product.weight * 453.592) : '0',
                                'shopify',
                                '0', // Inventory Qty
                                'deny',
                                'manual',
                                variantPrice,
                                '', // Compare At Price
                                'TRUE',
                                'TRUE',
                                '', // Barcode
                                validExportImages[0] || '',
                                imagePosition.toString(),
                                'FALSE',
                                'active',
                                costPerItem,
                                finalCollection
                            ]);
                            imagePosition++;
                        });
                    });
                } else if (axes.colors.length > 0) {
                    // One option: Color only
                    axes.colors.forEach((color, idx) => {
                        const tags = buildTags(product, breadcrumbs, { color });
                        const comboKey = buildComboKey(color, null);
                        const variantSku = buildVariantSku(baseSku, color, null);
                        const variantImage = validExportImages[idx] || validExportImages[0] || '';

                        variantRows.push([
                            handle,
                            product.name || 'Unnamed Product',
                            bodyHtml,
                            vendor,
                            productType,
                            tags,
                            'TRUE',
                            'Color',
                            color,
                            '', // Option2 Name
                            '', // Option2 Value
                            variantSku,
                            product.weight ? Math.round(product.weight * 453.592) : '0',
                            'shopify',
                            '0',
                            'deny',
                            'manual',
                            variantPrice,
                            '',
                            'TRUE',
                            'TRUE',
                            '',
                            variantImage,
                            imagePosition.toString(),
                            'FALSE',
                            'active',
                            costPerItem,
                            finalCollection
                        ]);
                        imagePosition++;
                    });
                } else if (axes.sizes.length > 0) {
                    // One option: Size only
                    axes.sizes.forEach(size => {
                        const tags = buildTags(product, breadcrumbs, { size });
                        const comboKey = buildComboKey(null, size);
                        const variantSku = buildVariantSku(baseSku, null, size);

                        variantRows.push([
                            handle,
                            product.name || 'Unnamed Product',
                            bodyHtml,
                            vendor,
                            productType,
                            tags,
                            'TRUE',
                            'Size',
                            size,
                            '',
                            '',
                            variantSku,
                            product.weight ? Math.round(product.weight * 453.592) : '0',
                            'shopify',
                            '0',
                            'deny',
                            'manual',
                            variantPrice,
                            '',
                            'TRUE',
                            'TRUE',
                            '',
                            validExportImages[0] || '',
                            imagePosition.toString(),
                            'FALSE',
                            'active',
                            costPerItem,
                            finalCollection
                        ]);
                        imagePosition++;
                    });
                } else {
                    // No variants: Default Title
                    const tags = buildTags(product, breadcrumbs);

                    variantRows.push([
                        handle,
                        product.name || 'Unnamed Product',
                        bodyHtml,
                        vendor,
                        productType,
                        tags,
                        'TRUE',
                        'Title',
                        'Default Title',
                        '',
                        '',
                        baseSku,
                        product.weight ? Math.round(product.weight * 453.592) : '0',
                        'shopify',
                        '0',
                        'deny',
                        'manual',
                        variantPrice,
                        '',
                        'TRUE',
                        'TRUE',
                        '',
                        validExportImages[0] || '',
                        '1',
                        'FALSE',
                        'active',
                        costPerItem,
                        finalCollection
                    ]);
                }

                console.log(`VARIANT_ROWS: ${variantRows.length} generated`);
                console.log(`TAGS_SNIPPET: ${buildTags(product, breadcrumbs).split(', ').slice(0, 10).join(', ')}...`);

                // Validations
                const firstRow = variantRows[0];
                if (firstRow[3] !== vendor) {
                    validationErrors.push(`Product ${productIdx + 1}: Vendor mismatch`);
                }
                if (firstRow[4] !== productType) {
                    validationErrors.push(`Product ${productIdx + 1}: Type mismatch`);
                }
                if (!firstRow[2].includes('Wayfair product page') && product.url) {
                    validationErrors.push(`Product ${productIdx + 1}: Missing source link in Body HTML`);
                }
                if (!firstRow[5].includes(`SKU:${baseSku}`) && baseSku) {
                    validationErrors.push(`Product ${productIdx + 1}: Missing SKU tag`);
                }

                rows.push(...variantRows);
            });

            // Validation Report
            if (validationErrors.length > 0) {
                console.error('\n❌ VALIDATION FAILURES:');
                validationErrors.forEach(err => console.error(`  - ${err}`));
                alert('CSV generation failed validation. Check console for details.');
                return;
            }

            console.log('\n✅ All validations passed!');
            console.log('========================================\n');

            // Convert to CSV
            const csvContent = rows.map(row =>
                row.map(cell => {
                    const str = String(cell || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(',')
            ).join('\n');

            // Download
            const firstHandle = products[0] ? normalizeHandle(products[0].name) : 'products';
            const filename = `shopify-products-${firstHandle}-ENRICHED.csv`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            console.log(`✅ CSV exported: ${filename}`);
        }

        // Carousel navigation
        function carouselNav(productIdx, direction) {
            const carousel = document.getElementById(`carousel-${productIdx}`);
            const images = carousel.querySelectorAll('.carousel-image');
            const counter = carousel.querySelector('.carousel-counter');

            // Find current active image
            let currentIdx = 0;
            images.forEach((img, idx) => {
                if (img.classList.contains('active')) {
                    currentIdx = idx;
                }
            });

            // Calculate new index
            let newIdx = currentIdx + direction;
            if (newIdx < 0) newIdx = images.length - 1;
            if (newIdx >= images.length) newIdx = 0;

            // Update active state
            images[currentIdx].classList.remove('active');
            images[newIdx].classList.add('active');

            // Update counter
            if (counter) {
                counter.textContent = `${newIdx + 1}/${images.length}`;
            }
        }

        // Reorder images
        function reorderImage(productIdx, direction) {
            const product = products[productIdx];
            if (!product.validatedImages || product.validatedImages.length < 2) return;

            const carousel = document.getElementById(`carousel-${productIdx}`);
            const images = carousel.querySelectorAll('.carousel-image');

            // Find current active image
            let currentIdx = 0;
            images.forEach((img, idx) => {
                if (img.classList.contains('active')) {
                    currentIdx = idx;
                }
            });

            // Calculate swap index
            let swapIdx = direction === 'up' ? currentIdx - 1 : currentIdx + 1;
            if (swapIdx < 0 || swapIdx >= product.validatedImages.length) return;

            // Swap in array
            const temp = product.validatedImages[currentIdx];
            product.validatedImages[currentIdx] = product.validatedImages[swapIdx];
            product.validatedImages[swapIdx] = temp;

            // Re-render review screen to show updated order
            renderReviewScreen();
        }

        // Delete current image
        function deleteImage(productIdx) {
            const product = products[productIdx];
            if (!product.validatedImages || product.validatedImages.length <= 1) {
                alert('Cannot delete the only image');
                return;
            }

            const carousel = document.getElementById(`carousel-${productIdx}`);
            const images = carousel.querySelectorAll('.carousel-image');

            // Find current active image
            let currentIdx = 0;
            images.forEach((img, idx) => {
                if (img.classList.contains('active')) {
                    currentIdx = idx;
                }
            });

            if (confirm(`Remove image ${currentIdx + 1}?`)) {
                product.validatedImages.splice(currentIdx, 1);
                renderReviewScreen();
            }
        }

        // Clear all
        function clearAll() {
            products = [];
            document.getElementById('productUrls').value = '';
            goToScreen(1);
        }
    </script>
</body>
</html>
